{"version":3,"sources":["../src/lib/copilotkit-runtime.ts"],"sourcesContent":["import {\n  Action,\n  ToolDefinition,\n  EXCLUDE_FROM_FORWARD_PROPS_KEYS,\n  actionToChatCompletionFunction,\n  Parameter,\n  AnnotatedFunction,\n  annotatedFunctionToAction,\n  COPILOT_CLOUD_PUBLIC_API_KEY_HEADER,\n  CopilotCloudConfig,\n} from \"@copilotkit/shared\";\nimport {\n  SingleChunkReadableStream,\n  copilotkitStreamInterceptor,\n  remoteChainToAction,\n} from \"../utils\";\nimport { RemoteChain, CopilotKitServiceAdapter } from \"../types\";\nimport { CopilotCloud, RemoteCopilotCloud } from \"./copilot-cloud\";\n\ninterface CopilotRuntimeResult {\n  stream: ReadableStream;\n  headers?: Record<string, string>;\n}\n\ninterface CopilotRuntimeConstructorParams<T extends Parameter[] | [] = []> {\n  actions?: Action<T>[];\n  langserve?: RemoteChain[];\n  debug?: boolean;\n  copilotCloud?: CopilotCloud;\n}\n\ninterface CopilotDeprecatedRuntimeConstructorParams<T extends Parameter[] | [] = []> {\n  actions?: AnnotatedFunction<any>[];\n  langserve?: RemoteChain[];\n  debug?: boolean;\n  copilotCloud?: CopilotCloud;\n}\n\nexport class CopilotRuntime<const T extends Parameter[] | [] = []> {\n  private actions: Action<any>[] = [];\n  private langserve: Promise<Action<any>>[] = [];\n  private debug: boolean = false;\n  private copilotCloud: CopilotCloud;\n\n  constructor(params?: CopilotRuntimeConstructorParams<T>);\n  // @deprecated use Action<T> instead of AnnotatedFunction<T>\n  constructor(params?: CopilotDeprecatedRuntimeConstructorParams<T>);\n  constructor(\n    params?: CopilotRuntimeConstructorParams<T> | CopilotDeprecatedRuntimeConstructorParams<T>,\n  ) {\n    for (const action of params?.actions || []) {\n      if (\"argumentAnnotations\" in action) {\n        this.actions.push(annotatedFunctionToAction(action));\n      } else {\n        this.actions.push(action);\n      }\n    }\n    for (const chain of params?.langserve || []) {\n      this.langserve.push(remoteChainToAction(chain));\n    }\n    this.debug = params?.debug || false;\n    this.copilotCloud = params?.copilotCloud || new RemoteCopilotCloud();\n  }\n\n  addAction<const T extends Parameter[] | [] = []>(action: Action<T>): void;\n  /** @deprecated Use addAction with Action<T> instead. */\n  addAction(action: AnnotatedFunction<any>): void;\n  addAction<const T extends Parameter[] | [] = []>(\n    action: Action<T> | AnnotatedFunction<any>,\n  ): void {\n    this.removeAction(action.name);\n    if (\"argumentAnnotations\" in action) {\n      this.actions.push(annotatedFunctionToAction(action));\n    } else {\n      this.actions.push(action);\n    }\n  }\n\n  removeAction(actionName: string): void {\n    this.actions = this.actions.filter((f) => f.name !== actionName);\n  }\n\n  removeBackendOnlyProps(forwardedProps: any): void {\n    // Get keys backendOnlyPropsKeys in order to remove them from the forwardedProps\n    const backendOnlyPropsKeys = forwardedProps[EXCLUDE_FROM_FORWARD_PROPS_KEYS];\n    if (Array.isArray(backendOnlyPropsKeys)) {\n      backendOnlyPropsKeys.forEach((key) => {\n        const success = Reflect.deleteProperty(forwardedProps, key);\n        if (!success) {\n          console.error(`Failed to delete property ${key}`);\n        }\n      });\n      // After deleting individual backend-only properties, delete the EXCLUDE_FROM_FORWARD_PROPS_KEYS property itself from forwardedProps\n      const success = Reflect.deleteProperty(forwardedProps, EXCLUDE_FROM_FORWARD_PROPS_KEYS);\n      if (!success) {\n        console.error(`Failed to delete EXCLUDE_FROM_FORWARD_PROPS_KEYS`);\n      }\n    } else if (backendOnlyPropsKeys) {\n      console.error(\"backendOnlyPropsKeys is not an array\");\n    }\n  }\n\n  private async getResponse(\n    forwardedProps: any,\n    serviceAdapter: CopilotKitServiceAdapter,\n    publicApiKey?: string,\n  ): Promise<CopilotRuntimeResult> {\n    this.removeBackendOnlyProps(forwardedProps);\n\n    // In case Copilot Cloud is configured remove it from the forwardedProps\n    const cloud: CopilotCloudConfig = forwardedProps.cloud;\n    delete forwardedProps.cloud;\n\n    const langserveFunctions: Action<any>[] = [];\n\n    for (const chainPromise of this.langserve) {\n      try {\n        const chain = await chainPromise;\n        langserveFunctions.push(chain);\n      } catch (error) {\n        console.error(\"Error loading langserve chain:\", error);\n      }\n    }\n\n    const serversideTools: Action<any>[] = [...this.actions, ...langserveFunctions];\n    const mergedTools = flattenToolCallsNoDuplicates([\n      ...serversideTools.map(actionToChatCompletionFunction),\n      ...(forwardedProps.tools || []),\n    ]);\n\n    try {\n      const result = await serviceAdapter.getResponse({\n        ...forwardedProps,\n        tools: mergedTools,\n      });\n\n      if (publicApiKey !== undefined) {\n        // wait for the cloud log chat to finish before streaming back the response\n        try {\n          const checkGuardrailsInputResult = await this.copilotCloud.checkGuardrailsInput({\n            cloud,\n            publicApiKey,\n            messages: forwardedProps.messages || [],\n          });\n\n          if (checkGuardrailsInputResult.status === \"denied\") {\n            // the chat was denied. instead of streaming back the response,\n            // we let the client know...\n            return {\n              stream: new SingleChunkReadableStream(checkGuardrailsInputResult.reason),\n              headers: result.headers,\n            };\n          }\n        } catch (error) {\n          console.error(\"Error checking guardrails:\", error);\n        }\n      }\n      const stream = copilotkitStreamInterceptor(result.stream, serversideTools, this.debug);\n      return { stream, headers: result.headers };\n    } catch (error) {\n      console.error(\"Error getting response:\", error);\n      throw error;\n    }\n  }\n\n  async response(req: Request, serviceAdapter: CopilotKitServiceAdapter): Promise<Response> {\n    const publicApiKey = req.headers.get(COPILOT_CLOUD_PUBLIC_API_KEY_HEADER) || undefined;\n    try {\n      const forwardedProps = await req.json();\n      const response = await this.getResponse(forwardedProps, serviceAdapter, publicApiKey);\n      return new Response(response.stream, { headers: response.headers });\n    } catch (error: any) {\n      return new Response(error, { status: error.status });\n    }\n  }\n\n  async streamHttpServerResponse(\n    req: any,\n    res: any,\n    serviceAdapter: CopilotKitServiceAdapter,\n    headers?: Record<string, string>,\n  ) {\n    const bodyParser = new Promise<any>((resolve, reject) => {\n      if (\"body\" in req) {\n        resolve(req.body);\n        return;\n      }\n      let body = \"\";\n      req.on(\"data\", (chunk: any) => (body += chunk.toString()));\n      req.on(\"end\", () => {\n        try {\n          resolve(JSON.parse(body));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    });\n    const forwardedProps = await bodyParser;\n    const publicApiKey =\n      (req.header\n        ? // use header() in express\n          req.header(COPILOT_CLOUD_PUBLIC_API_KEY_HEADER)\n        : // use headers in node http\n          req.headers[COPILOT_CLOUD_PUBLIC_API_KEY_HEADER.toLowerCase()]) || undefined;\n    const response = await this.getResponse(forwardedProps, serviceAdapter, publicApiKey);\n    const mergedHeaders = { ...headers, ...response.headers };\n    res.writeHead(200, mergedHeaders);\n    const stream = response.stream;\n    const reader = stream.getReader();\n\n    while (true) {\n      const { done, value } = await reader.read();\n      if (done) {\n        res.end();\n        break;\n      } else {\n        res.write(new TextDecoder().decode(value));\n      }\n    }\n  }\n}\n\nexport function flattenToolCallsNoDuplicates(toolsByPriority: ToolDefinition[]): ToolDefinition[] {\n  let allTools: ToolDefinition[] = [];\n  const allToolNames: string[] = [];\n  for (const tool of toolsByPriority) {\n    if (!allToolNames.includes(tool.function.name)) {\n      allTools.push(tool);\n      allToolNames.push(tool.function.name);\n    }\n  }\n  return allTools;\n}\n\n/**\n * @deprecated use CopilotRuntime instead\n */\nexport class CopilotBackend extends CopilotRuntime {}\n"],"mappings":";;;;;;;;;;;;AAAA;AAAA,EAGE;AAAA,EACA;AAAA,EAGA;AAAA,EACA;AAAA,OAEK;AA4BA,IAAM,iBAAN,MAA4D;AAAA,EASjE,YACE,QACA;AAVF,SAAQ,UAAyB,CAAC;AAClC,SAAQ,YAAoC,CAAC;AAC7C,SAAQ,QAAiB;AASvB,eAAW,WAAU,iCAAQ,YAAW,CAAC,GAAG;AAC1C,UAAI,yBAAyB,QAAQ;AACnC,aAAK,QAAQ,KAAK,0BAA0B,MAAM,CAAC;AAAA,MACrD,OAAO;AACL,aAAK,QAAQ,KAAK,MAAM;AAAA,MAC1B;AAAA,IACF;AACA,eAAW,UAAS,iCAAQ,cAAa,CAAC,GAAG;AAC3C,WAAK,UAAU,KAAK,oBAAoB,KAAK,CAAC;AAAA,IAChD;AACA,SAAK,SAAQ,iCAAQ,UAAS;AAC9B,SAAK,gBAAe,iCAAQ,iBAAgB,IAAI,mBAAmB;AAAA,EACrE;AAAA,EAKA,UACE,QACM;AACN,SAAK,aAAa,OAAO,IAAI;AAC7B,QAAI,yBAAyB,QAAQ;AACnC,WAAK,QAAQ,KAAK,0BAA0B,MAAM,CAAC;AAAA,IACrD,OAAO;AACL,WAAK,QAAQ,KAAK,MAAM;AAAA,IAC1B;AAAA,EACF;AAAA,EAEA,aAAa,YAA0B;AACrC,SAAK,UAAU,KAAK,QAAQ,OAAO,CAAC,MAAM,EAAE,SAAS,UAAU;AAAA,EACjE;AAAA,EAEA,uBAAuB,gBAA2B;AAEhD,UAAM,uBAAuB,eAAe,+BAA+B;AAC3E,QAAI,MAAM,QAAQ,oBAAoB,GAAG;AACvC,2BAAqB,QAAQ,CAAC,QAAQ;AACpC,cAAMA,WAAU,QAAQ,eAAe,gBAAgB,GAAG;AAC1D,YAAI,CAACA,UAAS;AACZ,kBAAQ,MAAM,6BAA6B,KAAK;AAAA,QAClD;AAAA,MACF,CAAC;AAED,YAAM,UAAU,QAAQ,eAAe,gBAAgB,+BAA+B;AACtF,UAAI,CAAC,SAAS;AACZ,gBAAQ,MAAM,kDAAkD;AAAA,MAClE;AAAA,IACF,WAAW,sBAAsB;AAC/B,cAAQ,MAAM,sCAAsC;AAAA,IACtD;AAAA,EACF;AAAA,EAEA,MAAc,YACZ,gBACA,gBACA,cAC+B;AAC/B,SAAK,uBAAuB,cAAc;AAG1C,UAAM,QAA4B,eAAe;AACjD,WAAO,eAAe;AAEtB,UAAM,qBAAoC,CAAC;AAE3C,eAAW,gBAAgB,KAAK,WAAW;AACzC,UAAI;AACF,cAAM,QAAQ,MAAM;AACpB,2BAAmB,KAAK,KAAK;AAAA,MAC/B,SAAS,OAAP;AACA,gBAAQ,MAAM,kCAAkC,KAAK;AAAA,MACvD;AAAA,IACF;AAEA,UAAM,kBAAiC,CAAC,GAAG,KAAK,SAAS,GAAG,kBAAkB;AAC9E,UAAM,cAAc,6BAA6B;AAAA,MAC/C,GAAG,gBAAgB,IAAI,8BAA8B;AAAA,MACrD,GAAI,eAAe,SAAS,CAAC;AAAA,IAC/B,CAAC;AAED,QAAI;AACF,YAAM,SAAS,MAAM,eAAe,YAAY;AAAA,QAC9C,GAAG;AAAA,QACH,OAAO;AAAA,MACT,CAAC;AAED,UAAI,iBAAiB,QAAW;AAE9B,YAAI;AACF,gBAAM,6BAA6B,MAAM,KAAK,aAAa,qBAAqB;AAAA,YAC9E;AAAA,YACA;AAAA,YACA,UAAU,eAAe,YAAY,CAAC;AAAA,UACxC,CAAC;AAED,cAAI,2BAA2B,WAAW,UAAU;AAGlD,mBAAO;AAAA,cACL,QAAQ,IAAI,0BAA0B,2BAA2B,MAAM;AAAA,cACvE,SAAS,OAAO;AAAA,YAClB;AAAA,UACF;AAAA,QACF,SAAS,OAAP;AACA,kBAAQ,MAAM,8BAA8B,KAAK;AAAA,QACnD;AAAA,MACF;AACA,YAAM,SAAS,4BAA4B,OAAO,QAAQ,iBAAiB,KAAK,KAAK;AACrF,aAAO,EAAE,QAAQ,SAAS,OAAO,QAAQ;AAAA,IAC3C,SAAS,OAAP;AACA,cAAQ,MAAM,2BAA2B,KAAK;AAC9C,YAAM;AAAA,IACR;AAAA,EACF;AAAA,EAEA,MAAM,SAAS,KAAc,gBAA6D;AACxF,UAAM,eAAe,IAAI,QAAQ,IAAI,mCAAmC,KAAK;AAC7E,QAAI;AACF,YAAM,iBAAiB,MAAM,IAAI,KAAK;AACtC,YAAM,WAAW,MAAM,KAAK,YAAY,gBAAgB,gBAAgB,YAAY;AACpF,aAAO,IAAI,SAAS,SAAS,QAAQ,EAAE,SAAS,SAAS,QAAQ,CAAC;AAAA,IACpE,SAAS,OAAP;AACA,aAAO,IAAI,SAAS,OAAO,EAAE,QAAQ,MAAM,OAAO,CAAC;AAAA,IACrD;AAAA,EACF;AAAA,EAEA,MAAM,yBACJ,KACA,KACA,gBACA,SACA;AACA,UAAM,aAAa,IAAI,QAAa,CAAC,SAAS,WAAW;AACvD,UAAI,UAAU,KAAK;AACjB,gBAAQ,IAAI,IAAI;AAChB;AAAA,MACF;AACA,UAAI,OAAO;AACX,UAAI,GAAG,QAAQ,CAAC,UAAgB,QAAQ,MAAM,SAAS,CAAE;AACzD,UAAI,GAAG,OAAO,MAAM;AAClB,YAAI;AACF,kBAAQ,KAAK,MAAM,IAAI,CAAC;AAAA,QAC1B,SAAS,OAAP;AACA,iBAAO,KAAK;AAAA,QACd;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AACD,UAAM,iBAAiB,MAAM;AAC7B,UAAM,gBACH,IAAI;AAAA;AAAA,MAED,IAAI,OAAO,mCAAmC;AAAA;AAAA;AAAA,MAE9C,IAAI,QAAQ,oCAAoC,YAAY,CAAC;AAAA,UAAM;AACzE,UAAM,WAAW,MAAM,KAAK,YAAY,gBAAgB,gBAAgB,YAAY;AACpF,UAAM,gBAAgB,EAAE,GAAG,SAAS,GAAG,SAAS,QAAQ;AACxD,QAAI,UAAU,KAAK,aAAa;AAChC,UAAM,SAAS,SAAS;AACxB,UAAM,SAAS,OAAO,UAAU;AAEhC,WAAO,MAAM;AACX,YAAM,EAAE,MAAM,MAAM,IAAI,MAAM,OAAO,KAAK;AAC1C,UAAI,MAAM;AACR,YAAI,IAAI;AACR;AAAA,MACF,OAAO;AACL,YAAI,MAAM,IAAI,YAAY,EAAE,OAAO,KAAK,CAAC;AAAA,MAC3C;AAAA,IACF;AAAA,EACF;AACF;AAEO,SAAS,6BAA6B,iBAAqD;AAChG,MAAI,WAA6B,CAAC;AAClC,QAAM,eAAyB,CAAC;AAChC,aAAW,QAAQ,iBAAiB;AAClC,QAAI,CAAC,aAAa,SAAS,KAAK,SAAS,IAAI,GAAG;AAC9C,eAAS,KAAK,IAAI;AAClB,mBAAa,KAAK,KAAK,SAAS,IAAI;AAAA,IACtC;AAAA,EACF;AACA,SAAO;AACT;AAKO,IAAM,iBAAN,cAA6B,eAAe;AAAC;","names":["success"]}